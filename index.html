<script>
document.addEventListener('DOMContentLoaded', () => {

  const itinerary = {
    "2025-10-24": [
      { text: "Flight to INCHEON (KOR) 11:45AM-8:15PM", image: "flight1.jpg" },
      { text: "AIRBNB Check-IN", image: "" }
    ]
  };

  function pad(n){return n.toString().padStart(2,'0')}
  function toYMD(date){ return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}` }
  function readableDate(ymd){
    const d = new Date(ymd + 'T00:00:00');
    return d.toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric', year:'numeric' });
  }

  function parseUserDate(text){
    text = text.trim();
    let m = text.match(/(20\d{2})[-\/](\d{1,2})[-\/](\d{1,2})/);
    if(m){ const [y,mo,da] = [m[1], pad(m[2]), pad(m[3])]; return `${y}-${mo}-${da}` }

    m = text.match(/(\d{1,2})[-\/](\d{1,2})[-\/](20\d{2})/);
    if(m){ const [d,mo,y] = [pad(m[1]), pad(m[2]), m[3]]; return `${y}-${mo}-${d}` }

    m = text.match(/(\d{1,2})(?:st|nd|rd|th)?\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec|january|february|march|april|may|june|july|august|september|october|november|december)\s*(\d{4})?/i);
    if(m){
      const day = pad(m[1]);
      const monthName = m[2].toLowerCase();
      const year = m[3] || new Date().getFullYear();
      const months = { jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12,
                       january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,
                       october:10,november:11,december:12 };
      let mm = months[monthName]; if(!mm) mm = months[monthName.slice(0,3)];
      return `${year}-${pad(mm)}-${day}`;
    }

    const d = new Date(text);
    if(!isNaN(d)) return toYMD(d);

    return null;
  }

  function findScheduleFromQuery(q){
    q = q.toLowerCase();
    if(/\btoday\b/.test(q)) return { type:'date', date: toYMD(new Date()) };
    if(/\btomorrow\b/.test(q)) { const d = new Date(); d.setDate(d.getDate()+1); return { type:'date', date: toYMD(d) }; }
    if(/\byesterday\b/.test(q)) { const d = new Date(); d.setDate(d.getDate()-1); return { type:'date', date: toYMD(d) }; }
    if(/\blist|all|itinerary\b/.test(q)) return { type:'all' };

    let m = q.match(/(20\d{2}[-\/]\d{1,2}[-\/]\d{1,2})/);
    if(m){ const parsed = parseUserDate(m[1]); if(parsed) return {type:'date', date:parsed} }

    m = q.match(/(\d{1,2}[-\/]\d{1,2}[-\/]20\d{2})/);
    if(m){ const parsed = parseUserDate(m[1]); if(parsed) return {type:'date', date:parsed} }

    m = q.match(/(\d{1,2}\s+(?:jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s*\d{0,4})/i);
    if(m){ const parsed = parseUserDate(m[1]); if(parsed) return {type:'date', date:parsed} }

    const parsed = parseUserDate(q);
    if(parsed) return { type:'date', date: parsed };

    return { type:'unknown' };
  }

  function replyForDate(ymd){
    if(itinerary[ymd]){
      const events = itinerary[ymd];
      let html = `<strong>${readableDate(ymd)}</strong> — You have ${events.length} item${events.length>1?"s":""}:<br>`;
      events.forEach((e,i)=>{
        html += `${i+1}. ${e.text || e} <br>`;
        if(e.image) html += `<img src="${e.image}" style="max-width:200px; border-radius:8px; margin:6px 0;"><br>`;
      });
      return html;
    }
    return `No events scheduled for ${readableDate(ymd)}.`;
  }

  function replyListAll(){
    const keys = Object.keys(itinerary).sort();
    if(keys.length===0) return 'No events in itinerary yet. Add events in the itinerary object.';
    let out = 'Full trip itinerary:\n';
    keys.forEach(k=>{
      out += `\n${readableDate(k)}:\n`;
      itinerary[k].forEach((e,i)=> out += `  ${i+1}. ${e.text || e}\n`);
    });
    return out.trim();
  }

  const chat = document.getElementById('chat');
  function addMessage(text, who='bot'){
    const div = document.createElement('div');
    div.className = 'bubble ' + (who==='user' ? 'user' : 'bot');
    if(who === 'user'){
      div.innerHTML = text.split('\n').map(x=>`<div>${escapeHtml(x)}</div>`).join('');
    } else {
      div.innerHTML = text;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

  const input = document.getElementById('userInput');
  const btn = document.getElementById('sendBtn');

  function handleQuery(){
    const q = input.value.trim(); if(!q) return;
    addMessage(q,'user');
    input.value = '';

    const parsed = findScheduleFromQuery(q);
    if(parsed.type === 'date') addMessage(replyForDate(parsed.date),'bot');
    else if(parsed.type === 'all') addMessage(replyListAll(),'bot');
    else addMessage(`Sorry, I couldn't find a date in that question. Try: "what's on today?", "what's on 2025-10-28", or "list all".`, 'bot');
  }

  btn.addEventListener('click', handleQuery);
  input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleQuery() });

  // initial friendly message
  addMessage(`Hey — I'm your trip chatbot. Ask me things like "what's on today?" or "what's on 2025-10-28". To update the trip, edit the itinerary object in this file.`, 'bot');

});
</script>
